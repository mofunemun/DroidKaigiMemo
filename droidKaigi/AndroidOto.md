# Android の音を制御する

## Android の音量を変更する方法

### 用語

- StreamType
  - Android 端末では複数のストリームがあり、複数の音を同時にならせる
  - 音の大きさも個別にかえられる
    - ミュージック
    - システム
    - 通話
    - 着信音
    - アラーム
    - アクセシビリティ
- AudioAttributes
  - 音声関連の設定をする時のクラス
  - StreamType 以上に細かい設定が可能
  - ビルダーを使って初期化し、各種メソッドで設定。
    - Usage を設定する
      - メディア
      - アラーム
      - 着信
      - 通話
      - アクセシビリティ
      - ゲーム
      - アシスタント
      - 通知
      - unknown
    - setContentType
      - 音楽
      - 動画
      - 口述
      - 効果音
      - unknown
    - setFlags
      - AUDIBILITY_ENFORCED
      - HW_AV
- AudioFocus
  - 複数のアプリから同じストリームに対して音声を流そうとするとミックスされてしまう
  - それを防ぐために AudioFocus を指定できる
    - 他のアプリから要求されるまで、AudioFocus を持つアプリからのみ音を出せる
    - アプリが AudioFocus を持つかどうかを検知するためのフラグがあるのでハンドリングも楽々

## 音を再生するには？

- SoundPool
  - 5 秒くらいしか流せないので効果音に
  - 使い方
    - まずは初期化しておく
    - load メソッドであらかじめ読み込んでおく
    - play メソッドで再生
    - 読み込み完了を検知する事もできるよ！
- MediaPlayer
  - ネットワーク上のメディアも再生可能
  - 長い音声を流すのに向いているが、遅延も発生する
  - 私用が終わったらリソース解放を忘れずに
- AudioTrack
  - 一番本格的
  - 音楽アプリなどで利用

## 音量を変更するには？

- AudioManager で音量調整用メソッドを呼び出す
  - AdjustVolume
    - 一段階ずつ音量を操作する
    - flags に振動や音声にエフェクトを漬けられる
  - adjustStreamVolume
    - これならストリームタイプを指定できる
  - adjustSuggestedStreamVolume
    - どのストリームを操作するのかを自動判断してくれる
  - setStreamVolume
    - 音量を数値で指定できる

## サイレントモード

- Android のサイレントモードをセットすると、音だけではなく通知などの視覚的なお知らせも止まる
- マナーモードよりも強力。
- 権限があればコードから制御できる
  - マニフェストファイルに権限を付与する記述を入れる
  - 設定画面からアプリにサイレントモード解除の切り替え許可を与える
    - この操作をユーザーにやってもらうため、初回起動時などに設定画面に遷移するようにするべし(権限があるかどうかの確認は必須)
    - 元の設定に戻せないこともあるので事前に警告が必要。
- ringerMode に任意の値を入れることで音量設定を変更できる
  - ただし端末差異あり

## 音量周りの端末差異

- サイレントモードの端末差異
  - 端末によっては「通知をミュート」「通知の鳴動制限」など
  - 英語にした場合「Do not Disturb」で大体同じ
- ringerMode 変更時の挙動
  - 基本的に API レベル 24 以上では権限無しで ringerMode で設定を変更できない
    - Security 例外を吐く
    - 端末によって例外をはくタイミングはまちまち。
  - また権限を許可していても、端末によって切り替え時にどのモードが切り替わるかなどで微妙な差異が出る
    - 調べてから実装しよう
- ストリーム毎の最大音量差異
  - 最新機種ではMUSICが大音量
  - アクセシビリティは基本的に同じ
  - 端末やストリームごとに最大音量が異なる
    - 音量設定を数値で行うのは危険
    - 最大値を出すメソッドがあるのでそれを使おう
