# 突撃！隣のコードレビュー

まさかの超満員

## コードレビューのお悩み

- レビューに時間がとられすぎる...
- ギスギスする...
- DMM のメンバーがどのように向き合っているかを紹介します

## DMM の開発体制

- 様々な領域で事業展開
  - 開発するアプリ・サービスも 1 つではない
  - 今回は以下のチームを紹介
    - DMM ポイントクラブ
    - DMMTV
    - DMM ブックス

## コードレビューの事例紹介

- DMM ポイントクラブ
  - チーム 5 名
  - AndroidView から compose への移行期
  - レビューの流れ
    - PR 作成時のセルフチェック
    - CI
    - 全員からの Approve までレビュー
    - マージ
  - 工夫していること
    - 実装前にクラス図などで実装の流れを共有
    - 実装後に使用するプルリクテンプレートを共有
      - issue
      - スクショ
      - 変更内容
      - 確認項目
      - テスト項目
      - モニタリングの要・不要
    - コードレビュータイムを設ける
      - 1 日 2 回各 30 分。
  - 課題
    - レビューが終わらない...
  - 解決策
    - 午前のレビュータイムでは実装内容を口頭説明するようにした
      - コミュニケーションの増加
      - ジュニアメンバーのキャッチアップに有効
  - 積み残し
    - スプリント終盤にたまるレビュー消化
    - レビュアーが偏る
- DMMTV
  - KMP を使用し iOS などと機能を共有
  - 8 名
  - レビューの流れ
    - 各 PF への影響判断
    - CI
    - 全員からの Approve までレビュー
    - マージ
  - 工夫
    - 1PR あたり 500 行以内にする
    - Bitrise でビルドチェックをコメントで可能にする
    - 定期的に slack でリマインド
    - 各 PF 向けのチェック項目を PR のテンプレに入れている
  - 課題
    - ダウンロードなど、特定分野ではレビュアーが偏る
    - 修正内容が分からない PR は放置されてしまいがち
  - 解決策
    - 行数削減、スコープを狭める
    - 背景知識の記載
  - 積み残し
    - CI/CD 導入
- DMM ブックス

  - 5 名
  - アジャイル
  - Kotlin で MVVM
  - 現在はリファクタリングが主で、Compose への移行はまだ
  - 工夫
    - 変更は 200 行前後にしよう
    - 設計に時間をかける
      - プロセス説明、クラス図を作成
      - 冗長な設計にならないよう、メンバー間でレビュー観点を共有する。
      - 要検討項目は事前に共有済なので、レビューで注目すべきポイントが絞られている。
  - 積み残し
    - 人数増えたらキツよね
    - 動作確認の室が均一化できていない
      - QA チームと共同でシナリオテストを作成中
      - 確認すべきことを文書化したい

- どのチームでもレビュアーの偏りが課題
  - メンバーの教育によってクリアする

## レビュアー個人の工夫

- 認識をあわせる
  - ちょっとした疑問でも聞く
  - PR 上でのやり取りが長くなる場合、対面レビューなど早期解決にシフトすべき
  - コメントの背景を明記する
- PR を記録やナレッジとして活用できるようにする
  - 口頭で確認したことも PR に文字で残そう
    - 言った言わない問題を防ぐ
    - 関係者以外にも実装意図が伝わる
  - 指摘に対して修正するだけでなく、返信・Resolve されたか確認する
  - レビューコメントを書く時には相手の役に立つように詳細に書くべし
- smooth にレビューする
  - 自分のタスクよりもコードレビューを優先する
    - これが遅れると工程が遅れる
  - 指摘の優先度が分かるようにキーワードを付ける
    - MUST,IMO など
- 心地よいコミュニケーション
  - 緩い感じの文体でコメントする
  - 書き方の好みを押し付けない
  - いいと思ったところもコメントする
- そのほか
  - レビューしたコードを他の人に説明できるくらい責任を持つ

## レビュイー個人の工夫

- PR の粒度がデカい場合は申し送りを付してサイズを減らす
  - 「○○ は後続でやります」
  - 本筋以外の修正を含めない
  - コミットを分割する
- 読みやすい PR にする
  - 意味のあるまとまりで PR を作成する
  - 処理の説明は PR コメントでも補足する
- レビューに必要な情報を用意しておく
  - 仕様書・デザイン
  - 動作確認のエビデンスとしてスクショと動画を貼る
- 指摘を修正したらコミットのリンクを付して返信

## Android ならではのレビュー視点

- iOSに比べ端末が多い
  - 画面幅とUI
    - 画面サイズが小さい/大きいに対応できているか？
    - 画面ズーム・文字サイズ
  - パフォーマンス
    - メインセーフか？
    - メモリリークしてないか？
    - 入れ子が深くないか？
  - 画面再生成やOSバージョン間の差分
