# Kotlin ハイパフォーマンスプログラミング

## 主題

- Yahoo のお天気アプリに参画
  - 粒子を使った描画のためかなり処理が重い
  - チーム参画後、リファクタリングを行って高速化した

## Kotlin って遅いの？

- JAVA などで高速化すべきという意見もある
  - ただ、その前に Kotlin で最適化を測るべき
  - Kotlin で遅い処理はネイティブだろうが遅い
- そもそも JVM 言語が遅いというのは過去の話
  - AOTcompile
  - JITcompile

## Android アプリを Kotlin で実装するメリット

- Kotlin 以外の言語で開発できる人員は少ない
  - 人員不足・メンテ困難などを呼び込むことが有る
- Kotlin は高水準言語
  - ハードウェアを意識しなくてもいい
  - ボイラープレート不要等
  - これらがデメリットになる場合もある

## どう高速化する？

- やらないこと
  - そもそもモバイルは電池や CPU などで制約が多い
  - 大量のデータ処理に向かない
  - 本当にやらなければならない処理以外は省くべき
- パレートの法則
  - 処理時間の 80%はコード全体の 20%が閉める
  - ↑ に当てはまる部分に高速化を。
  - ただ極端な高速化よりもメンテ性を重視しようね

## メモリは(CPU に比べ)遅い

- そもそもデータは以下の階層になっている
  - CPU
  - レジスタ
  - キャッシュ
  - メインメモリ
  - ストレージ
- メインメモリは CPU から遠く、数百倍・数千倍遅い
  - どうやってメモリアクセスを減らすのかが大切
  - 場合によってはメモリに計算結果を保存するよりも毎回計算した方が早い場合もある
- メモリのコピーに気を付けよう
  - 避けられるものではないが、大量のデータはコピーを最小限に
- インスタンスの使い捨て
  - Kotlin では発生しがち
  - 度重なるとものすごい負荷に

## Kotlin の便利記法とコスト

- 2 つの値をかえす関数
  - タプルや分解宣言
  - Java に直すと、プリミティブラッパーが内部で使い捨てされていることが分かる
  - 可読性・メンテナンス性には GOOD だが、大量・高頻度の場合は慎重に
  - インスタンスを一度生成して、それに引数をかえながら渡すような実装にすることで使い捨てを防げる
  - Kotlin ではプリミティブラッパーを区別しない
    - ただし、Nullable・ジェネリクス・コレクションでは私用を矯正してしまう
    - IntArrayと Array<Int> は Java でやることが違う
- コレクション操作
  - map,filter,find など
  - 物によっては新しい Collection を生成して対応している場合がある
  - 大量のデータでこれをやると重くなる
  - 一旦 asSequence()を使うことで、値の詰め替えをせず終端のみで処理される
  - ただし小さなメソッドに asSequence()を使うとかえって遅くなる
    - 呼び出しのコストと詰め替えのコスト
  - for でべた書きするのが実は最高速
- 可変長引数とスプレッド演算子
  - 引数の数を範囲指定できる
  - 内部で配列が 2 度コピーされるなど、冗長な構造になりやすい
  - 大量のデータを渡したりループの中で使うとしんどい

## アルゴリズムとデータ構造

- ランダウの記号
  - 計算量を比較するときの指標
  - ただしこれが少ない＝絶対に早いではない
    - ランダウ記法は n が十分に大きくないと成立しない
    - 計算量が少ないからと言って早いとは限らない
    - データ構造を変化させるだけでも劇的に変わることもある
- Kotlin の標準関数と、原始的なソート実装で比較
  - 要素数が少ない場合、原始的な物の方が早いことがある
- 数学的正しさにとらわれすぎない
  - 必要な計算精度を意識して、必要な限りの正確性にとどめるべし
  - ロジックの正確性
    - ユークリッド距離の方が正しいが、計算が多すぎる
    - マンハッタン距離でもいい場合があるよね
- 本質的に無駄になることをやっていないか？
  - 使われない計算が無いか？
  - 境界条件で整理してみよう
- 1 回やればいいことは繰り返さない！
  - データの下処理をしておくことで手間を減らそう

## 高速化のためにも可読性が重要

- 高速化しようとすると可読性が犠牲になることがある
  - カプセル化して影響を極小化しよう
- 計測を軽視しないように
  - どんどん計測・Print デバッグしよう
