# モニタリングでパフォーマンス改善入門

## Android にはパフォーマンスガイドがあるのでそれを紹介します

- 用語
  - ジャンク(View のレンダリング遅延によりフレームがスキップされる)
    - フリーズ(レンダリングで 700 ミリ秒以上応答がない)
    - ANR(応答なしダイアログが表示される)
- パフォーマンスの検査は 3 種類
  - Passive
  - Auto
  - Manual
- 検査時の注意点
  - 可能な限り本番環境でやるべし

- test の手法紹介

  - passive

    - ざっくり原因をみつける
    - アプリを動かしながら LogCat をみる
    - 検出したい現象に応じて tag を使い分ける
      - 直感的ではあるが、原因究明が困難
      - Activity の起動にかかる時間も検証できる
      - OpenGLRenderer

  - manual

    - 具体的な修正箇所を発見する
    - 問題のデバッグをすること
      - アプリの操作をグラフ化して原因追及
    - Profile を用いて行う
      - debuggable かプロファイラブルにする
      - JunkyFrames がまとまっているので、ジャンクの確認には良い
    - Perfetto を使う
      - パフォーマンス測定サイト
      - Linux カーネルをトレースできるので、アプリ単体ではなく、端末全体の動作を見れる
      - 手軽さは Profiler の方が上
      - システムトレースの設定を有効化して、そのファイルをドライブなりあげる
      - ファイルを Perfetto に食わせる

  - Auto
    - 修正完了後のチェックに
    - マクロベンチマークとマイクロベンチマーク
    - マクロベンチマーク
      - いくつかの動作のふくごうをテストする
      - 自動で実行にかかる時間を計測してくれる。
        　- テスト完了後には移動でトレースをはいてくれる

- モニタリング

  - Andronoid Vitals
    - クラッシュ率・ANR 率が高すぎると検索結果に出て来なくなるなどペナルティもある
    - 申請画面から確認できる。
    - 前バージョンや類似アプリなど照合する
    - バージョン情報、スタックトレースなどを確認できる
    - Crashlytics では見られないイベントもキャプチャ可能だよ！
    - ただし Google Play からダウンロードしたアプリを公認デバイスで動かしたときのみ対象
    - なおゲーム系の場合は別のプラグインもあるよ

- Firebase Performance Monitoringview

  - SDK を入れるだけで計測！
  - 各プロセス通信にかかる時間を測定
  - 匿名化されたピックアップ情報も拾える
    - ユーザーの 90%はちゃんと表示できてるけど 10%の人は動作もっさりだな...

- JankStats
  - WindowObject を監視し、提示報告をしてくれる
    - frame の開始時間とその持続時間
    - ↑ これジャンクか？を判断する
  - 独自の State も追加可能で、どの操作中にもっさりしているかを検証するヒントを埋め込める
